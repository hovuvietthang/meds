<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MEDSTRIAL • Đăng ký dùng thử MEDS+ (Xác thực 2 lớp)</title>

  <meta name="description" content="Phần mềm chia giờ dịch vụ kỹ thuật YHCT &amp; PHCN chuẩn BHYT. Đăng ký dùng thử MEDS+ qua xác thực OTP Email an toàn." />
  <link rel="canonical" href="https://medstrial.toihocy.com/" />
  
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --meds-primary:#2563eb; --meds-dark:#1e40af; --meds-accent:#06b6d4;
      --meds-text:#e5e7eb; --meds-bg:#0b1220;
      --meds-border:#1f2a44; --surface:rgba(15,23,42,.88);
      --meds-info-br:#1e3a8a; --logo-max:320px; --logo-nudge:18px;
      --meds-ok-br:#2dd4bf; --meds-ok-bg:#052e2a;
      --meds-new-br:#f59e0b; --meds-new-bg:#3a1a01;
    }

    /* ===== Nền & layering ===== */
    html,body{min-height:100%; background:var(--meds-bg);} 
    body{color:var(--meds-text); isolation:isolate;}
    #bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
    #content{position:relative; z-index:1;}

    .scene{
      position:absolute; inset:0;
      background:
        radial-gradient(60% 40% at 15% 10%, rgba(37,99,235,.30) 0%, transparent 60%),
        radial-gradient(50% 35% at 85% 15%, rgba(6,182,212,.25) 0%, transparent 60%),
        radial-gradient(70% 50% at 50% 95%, rgba(30,64,175,.35) 0%, transparent 70%),
        linear-gradient(180deg, #0b1220 0%, #0b1120 30%, #0b1220 100%);
      filter:saturate(1.06);
    }
    .gridbg{
      position:absolute; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size:24px 24px;
      mask-image: radial-gradient(60% 60% at 50% 40%, rgba(0,0,0,.9), rgba(0,0,0,0));
      opacity:.5;
    }
    .aurora{
      position:absolute; inset:0; filter:blur(30px); mix-blend-mode:screen;
      background:
        radial-gradient(30% 30% at 10% 20%, rgba(37,99,235,.25), transparent 60%),
        radial-gradient(25% 30% at 90% 10%, rgba(6,182,212,.20), transparent 60%);
      animation:float 18s ease-in-out infinite alternate;
    }
    @keyframes float{from{transform:translateY(-6px)}to{transform:translateY(6px)}}

    /* Logo */
    .logo-wrap{filter:drop-shadow(0 8px 22px rgba(14,165,233,.20));}
    .logo-svg{width:100%;height:auto;max-width:var(--logo-max);display:block;margin-inline:auto;}

    /* Card glass */
    .glass{
      background:var(--surface);
      border:1px solid var(--meds-border);
      border-radius:1rem;
      box-shadow:0 10px 30px rgba(2,6,23,.35), 0 1px 0 0 rgba(255,255,255,.04) inset;
    }
    @supports (backdrop-filter: blur(10px)){
      .glass{ backdrop-filter: blur(14px); background:rgba(15,23,42,.72); }
    }

    .input{
      width:100%; background:rgba(2,6,23,.45); color:#e5e7eb; border:1px solid #21314f; border-radius:0.75rem; padding:0.675rem 1rem;
    }
    .input::placeholder{ color: #94a3b8; }
    .input:focus{ border-color:var(--meds-primary); box-shadow:0 0 0 4px rgba(37,99,235,.18); outline:none; }

    /* OTP */
    #otp{letter-spacing:.35em; text-align:center; font-variant-numeric:tabular-nums; font-family:ui-monospace,SFMono-Regular,Menlo,monospace;}

    /* Badge */
    .badge-old{ border-color:var(--meds-ok-br); background:var(--meds-ok-bg); color:#99f6e4; }
    .badge-new{ border-color:var(--meds-new-br); background:var(--meds-new-bg); color:#fdba74; }
  </style>
</head>
<body>
  <div id="bg" aria-hidden="true">
    <div class="scene"></div>
    <div class="aurora"></div>
    <div class="gridbg"></div>
  </div>

  <div id="content">
    <main class="mx-auto w-full max-w-xl px-4 py-10">
      <header class="mb-8 text-center">
        <div class="logo-wrap mx-auto mb-4 flex justify-center">
          <svg class="logo-svg" viewBox="0 0 900 260" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
            <title>MedS Logo</title>
            <defs>
              <filter id="ds" x="-20%" y="-20%" width="140%" height="140%">
                <feOffset dx="0" dy="4" in="SourceAlpha" result="off"/><feGaussianBlur in="off" stdDeviation="6" result="blur"/>
                <feColorMatrix in="blur" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 0 .22 0" result="shadow"/><feBlend in="SourceGraphic" in2="shadow" mode="normal"/>
              </filter>
              <linearGradient id="gShield" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--meds-primary)"/><stop offset="100%" stop-color="var(--meds-dark)"/></linearGradient>
              <linearGradient id="gHead" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="var(--meds-primary)"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient>
            </defs>
            <g class="logo-visual">
              <g transform="translate(20,20)" filter="url(#ds)">
                <path d="M100,0 L200,30 L200,120 C200,170 160,210 100,240 C40,210 0,170 0,120 L0,30 Z" fill="url(#gShield)"/>
                <g transform="translate(35,40)">
                  <rect x="0" y="18" rx="10" ry="10" width="130" height="110" fill="white" opacity="0.96"/>
                  <rect x="0" y="18" width="130" height="28" rx="10" ry="10" fill="url(#gHead)"/>
                  <circle cx="28" cy="18" r="6.5" fill="white"/><circle cx="102" cy="18" r="6.5" fill="white"/>
                  <g fill="#d1d5db"><rect x="12" y="56" width="18" height="16" rx="3"/><rect x="36" y="56" width="18" height="16" rx="3"/><rect x="60" y="56" width="18" height="16" rx="3"/><rect x="84" y="56" width="18" height="16" rx="3"/><rect x="12" y="78" width="18" height="16" rx="3"/><rect x="36" y="78" width="18" height="16" rx="3"/><rect x="60" y="78" width="18" height="16" rx="3"/><rect x="84" y="78" width="18" height="16" rx="3"/><rect x="12" y="100" width="18" height="16" rx="3"/><rect x="36" y="100" width="18" height="16" rx="3"/><rect x="60" y="100" width="18" height="16" rx="3"/><rect x="84" y="100" width="18" height="16" rx="3"/></g>
                  <g transform="translate(92,92)"><rect x="-10" y="-26" width="20" height="52" rx="3" fill="var(--meds-accent)"/><rect x="-26" y="-10" width="52" height="20" rx="3" fill="var(--meds-accent)"/></g>
                </g>
              </g>
              <g transform="translate(280,150)">
                <text x="0" y="0" font-family="sans-serif" font-weight="800" font-size="90" fill="#e5e7eb">MED</text>
                <text x="210" y="0" font-family="sans-serif" font-weight="900" font-size="96" fill="var(--meds-primary)">S+</text>
              </g>
            </g>
          </svg>
        </div>

        <h1 class="mt-2 text-center text-xl font-extrabold text-slate-100 sm:text-2xl">
          Đăng ký dùng thử MEDS+
        </h1>
        <p class="mt-1 text-center text-sm text-slate-300">
          Xác thực OTP qua Email · Bảo mật & An toàn
        </p>
      </header>

      <section class="glass p-6 md:p-8">
        <form id="trialForm" class="space-y-6">
          
          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
            <div>
              <label for="hoten" class="mb-1.5 block text-sm font-medium text-slate-100">Họ và tên</label>
              <input id="hoten" name="hoten" type="text" required placeholder="Ví dụ: Nguyễn Văn A" class="input placeholder:text-slate-400">
            </div>
            <div>
              <label for="sdt" class="mb-1.5 block text-sm font-medium text-slate-100">Số điện thoại (Zalo)</label>
              <input id="sdt" name="sdt" type="tel" inputmode="numeric" required placeholder="Ví dụ: 0901234567" class="input placeholder:text-slate-400">
              <p class="mt-1 text-[11px] text-slate-400">
                ⚠️ <b>Quên tài khoản?</b> Nhập đúng <b>SĐT & Email</b> đã đăng ký để hệ thống cấp lại link.
              </p>
            </div>
          </div>

          <div>
            <label for="email" class="mb-1.5 block text-sm font-medium text-slate-100">Email nhận mã xác thực (OTP)</label>
            <input id="email" name="email" type="email" required placeholder="Ví dụ: bacsi@gmail.com" class="input placeholder:text-slate-400">
            <p class="mt-1 text-[11px] text-slate-400">
              Mã OTP sẽ được gửi về email này. Vui lòng nhập chính xác.
            </p>
          </div>

          <div class="text-xs uppercase tracking-wide text-slate-300/80 pt-2 border-t border-white/10">Bước 1 • Gửi mã xác thực</div>
          <div id="step1" class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-center">
            <button id="sendOtpBtn" type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-[var(--meds-primary)] px-5 py-2.5 text-sm font-semibold text-white shadow hover:bg-[var(--meds-dark)] focus:outline-none focus:ring-2 focus:ring-[color:rgba(37,99,235,.25)] disabled:opacity-60">
              <svg id="spinner1" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4A4 4 0 0 0 8 12H4z"></path>
              </svg>
              <span>Gửi mã xác thực vào Email</span>
            </button>
            <span id="status1" class="text-sm text-slate-300" aria-live="polite"></span>
          </div>

          <div id="step2" class="hidden space-y-4 pt-4 border-t border-white/10">
            <div class="text-xs uppercase tracking-wide text-slate-300/80">Bước 2 • Nhập mã &amp; nhận liên kết</div>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
              <div class="grow">
                <label for="otp" class="mb-1.5 block text-sm font-medium text-slate-100">
                  Nhập mã 6 số đã gửi tới <span id="emailMasked" class="font-semibold text-white"></span>
                </label>
                <input id="otp" name="otp" inputmode="numeric" pattern="\\d{6}" maxlength="6"
                       placeholder="• • • • • •" class="input text-center text-lg tracking-widest font-bold">
              </div>
              <button id="resendBtn" type="button"
                      class="rounded-xl border border-white/20 bg-white/5 px-3 py-3 text-sm hover:bg-white/10 whitespace-nowrap">
                Gửi lại mã
              </button>
            </div>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-center pt-2">
              <button id="verifyBtn" type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-6 py-3 text-sm font-bold text-white shadow hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-300 disabled:opacity-60 w-full sm:w-auto">
                <svg id="spinner2" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4A4 4 0 0 0 8 12H4z"></path>
                </svg>
                <span>Xác nhận &amp; Nhận Link</span>
              </button>
            </div>
            <div class="text-center"><span id="status2" class="text-sm text-slate-300" aria-live="polite"></span></div>
          </div>

          <div id="errorBox" role="alert" class="hidden rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-300"></div>

          <div id="resultBox" class="hidden rounded-2xl border border-[var(--meds-info-br)] bg-[color:rgba(30,58,138,.35)] p-4 backdrop-blur">
            <div class="flex flex-col gap-3">
              <div class="min-w-0">
                <p class="text-sm font-medium text-slate-200">Liên kết truy cập dành riêng cho bạn:</p>
                <div class="mt-1 flex items-center gap-2">
                   <a id="deployLink" href="#" target="_blank" rel="noopener" class="block truncate text-base font-bold text-blue-300 underline bg-black/20 p-2 rounded w-full">Đang xử lý…</a>
                </div>
                <div class="mt-2 flex items-center justify-between">
                   <span id="modeBadge" class="inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] font-semibold"></span>
                   <p class="text-xs text-slate-300">Mật khẩu mặc định: <span class="font-mono font-bold text-white bg-white/10 px-1 rounded">meds</span></p>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button type="button" id="openBtn" class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700">Mở ngay</button>
                <button type="button" id="copyBtn" class="rounded-xl border border-[var(--meds-border)] bg-white/5 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-white/10">Sao chép</button>
              </div>
            </div>
          </div>
        </form>
      </section>

      <footer class="mt-8 text-center text-xs text-slate-400">
        © <span id="y"></span> MEDS • Phát triển bởi Bác sĩ Hồ Vũ Việt Thắng
      </footer>
    </main>
  </div>

  <script>
    // ========= CẤU HÌNH =========
    // THAY LINK NÀY BẰNG LINK WEB APP CỦA BẠN (Kết thúc bằng /exec)
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxrJ6fbQmUeyuSLCd5JF_5soEFLgEgQwySqzG6MBrJVJ1TXdK8Xo7gglChnl8ypbAFt/exec';

    // ========= HELPER =========
    const normalizePhone = s => String(s||'').replace(/\D/g,'');
    const isValidPhone = d => /^\d{9,12}$/.test(d);
    const isValidEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim());
    const $ = s => document.querySelector(s);
    const show = (el, yes=true)=> el.classList.toggle('hidden', !yes);

    let OTP_TOKEN = '';
    let RESEND_COOLDOWN = 0, resendTimer = null;

    async function api(body){
      const res = await fetch(WEBAPP_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(body),
        cache:'no-store', redirect:'follow'
      });
      return await res.json();
    }

    // ========= SỰ KIỆN =========

    // 1. Gửi OTP
    $('#sendOtpBtn').addEventListener('click', async ()=>{
      const hoten = $('#hoten').value.trim();
      const sdt = normalizePhone($('#sdt').value.trim());
      const email = $('#email').value.trim();

      const err = $('#errorBox'), st1 = $('#status1'), btn = $('#sendOtpBtn'), sp = $('#spinner1');
      show(err,false); st1.textContent='';

      if(!hoten){ err.textContent='Vui lòng nhập họ và tên.'; return show(err,true); }
      if(!isValidPhone(sdt)){ err.textContent='Số điện thoại không hợp lệ.'; return show(err,true); }
      if(!isValidEmail(email)){ err.textContent='Email không hợp lệ.'; return show(err,true); }

      btn.disabled=true; show(sp,true); st1.textContent='Đang gửi mã…';
      
      try{
        // Gửi cả email lên server
        const data = await api({ action:'request_otp', hoten, sdt, email });
        
        if(data?.success){
          OTP_TOKEN = data.token;
          $('#emailMasked').textContent = email; // Hiển thị email để user check
          show($('#step2'), true);
          st1.textContent = `Đã gửi mã (hết hạn sau ${Math.floor((data.expiresIn||600)/60)} phút).`;
          startResendCooldown(60);
          $('#otp').focus();
        }else{
          throw new Error(data?.error || 'Không thể gửi mã.');
        }
      }catch(e){
        err.textContent = e.message || String(e);
        show(err,true);
      }finally{
        btn.disabled=false; show(sp,false);
      }
    });

    // 2. Gửi lại mã
    $('#resendBtn').addEventListener('click', ()=>{
      if(RESEND_COOLDOWN>0) return;
      $('#sendOtpBtn').click();
    });

    function startResendCooldown(s){
      RESEND_COOLDOWN = s;
      const btn = $('#resendBtn');
      btn.disabled = true;
      btn.textContent = `Gửi lại (${RESEND_COOLDOWN}s)`;
      clearInterval(resendTimer);
      resendTimer = setInterval(()=>{
        RESEND_COOLDOWN--;
        if(RESEND_COOLDOWN<=0){
          clearInterval(resendTimer);
          btn.disabled = false;
          btn.textContent = 'Gửi lại mã';
        }else{
          btn.textContent = `Gửi lại (${RESEND_COOLDOWN}s)`;
        }
      },1000);
    }

    // 3. Xác minh OTP & Lấy Link
    $('#verifyBtn').addEventListener('click', async ()=>{
      const code = ($('#otp').value || '').replace(/\D/g,'').slice(0,6);
      const err = $('#errorBox'), st2 = $('#status2'), btn = $('#verifyBtn'), sp = $('#spinner2');
      const result = $('#resultBox');

      show(err,false); st2.textContent=''; show(result,false);
      
      if(!OTP_TOKEN){ err.textContent='Vui lòng yêu cầu mã xác thực trước.'; return show(err,true); }
      if(!/^\d{6}$/.test(code)){ err.textContent='Mã OTP phải có 6 chữ số.'; return show(err,true); }

      btn.disabled=true; show(sp,true); st2.textContent='Đang xác thực…';
      
      try{
        // Gửi sendEmail:true để server tự gửi link vào mail nếu thành công
        const data = await api({ action:'verify', token: OTP_TOKEN, code, sendEmail: true });
        
        if(data?.success){
          const a = $('#deployLink'), badge = $('#modeBadge');
          const link = data.link || '#';
          a.href = link; a.textContent = link;

          const isOld = data.mode === 'exists';
          badge.textContent = isOld ? 'TÀI KHOẢN CŨ' : 'ĐĂNG KÝ MỚI';
          badge.className = 'inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] font-bold ' + (isOld ? 'badge-old' : 'badge-new');
          
          show(result,true);
          
          // Thông báo trạng thái gửi email
          if(data.emailed) {
             st2.innerHTML = '<span class="text-emerald-400">Thành công! Đã gửi bản sao liên kết về Email.</span>';
          } else {
             st2.textContent = 'Thành công. (Chưa gửi được email, hãy copy link bên dưới)';
          }
          
          // Ẩn bớt các bước trên cho gọn
          $('#step1').classList.add('opacity-50', 'pointer-events-none');
          $('#verifyBtn').classList.add('hidden');
        }
        else{
          throw new Error(data?.error || 'Mã xác thực không đúng.');
        }
      }catch(e){
        err.textContent = e.message || String(e);
        show(err,true);
        st2.textContent='';
      }finally{
        btn.disabled=false; show(sp,false);
      }
    });

    // 4. Các nút chức năng
    $('#openBtn').addEventListener('click', ()=>{ const href=$('#deployLink').href; if(href && href!=='#') window.open(href,'_blank','noopener'); });
    
    $('#copyBtn').addEventListener('click', async ()=>{
      const href = $('#deployLink').href || '';
      try{ await navigator.clipboard.writeText(href); alert('Đã copy liên kết!'); }
      catch{ alert('Lỗi copy. Bạn hãy bôi đen và copy thủ công.'); }
    });

    $('#y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
